<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å‡∏ó‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà ‚Äì ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏†‡∏≤‡∏Ñ‡∏™‡∏ô‡∏≤‡∏° (AI Assistant)</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root {
    /* ===== Military Theme Color Palette ===== */
    --bg: #f4f1e8;          /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©/‡∏Å‡∏≤‡∏Å‡∏µ‡∏≠‡πà‡∏≠‡∏ô */
    --paper: #ffffff;       /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≤‡∏ß‡∏™‡∏∞‡∏≠‡∏≤‡∏î */
    --ink: #1c1e1a;         /* ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏™‡∏µ‡∏î‡∏≥‡πÄ‡∏Ç‡πâ‡∏°‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏™‡∏ô‡∏¥‡∏ó */
    --muted: #5e6b5a;       /* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠‡∏á‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏°‡πà‡∏ô */
    --line: #dcdfda;        /* ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß */
    --brand: #4a5c43;       /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏´‡∏≤‡∏£ (Olive Drab) */
    --brand-dark: #354230;  /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡∏Å‡∏ß‡πà‡∏≤ */
    --brand-accent: #c0392b; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡πâ‡∏ô */
    --radius: 8px;          /* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏•‡∏á */
    --shadow: 0 4px 8px -4px rgba(0,0,0,.2);
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", Arial, sans-serif;
    background: var(--bg);
    color: var(--ink);
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }

  .wrap { max-width: 980px; margin: 0 auto; padding: 16px; padding-bottom: 80px; }

  .header {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px;
    border: 1px solid var(--line);
    border-radius: var(--radius);
    background: var(--paper);
    box-shadow: var(--shadow);
  }
  .crest {
    width: 48px; height: 48px;
    border-radius: var(--radius);
    display: grid; place-items: center;
    background: var(--brand);
    color: #fff;
    font-size: 26px;
    font-weight: 700;
    flex-shrink: 0;
  }
  h1 { 
    margin: 0; 
    font-size: clamp(18px, 5vw, 24px); 
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .subtitle { margin: 2px 0 0; color: var(--muted); font-size: clamp(12px, 3.2vw, 14px); }

  /* Section Title */
  .section { margin-top: 24px; }
  .section h2 {
      margin: 0 0 12px;
      font-size: 18px;
      padding-bottom: 4px;
      border-bottom: 2px solid var(--line);
  }
  
  .grid {
    display: grid;
    gap: 12px;
    grid-template-columns: 1fr;
  }
  @media (min-width: 540px) { .grid { grid-template-columns: 1fr 1fr; } }
  @media (min-width: 840px) { .grid { grid-template-columns: 1fr 1fr 1fr; } }

  /* ‡∏õ‡∏∏‡πà‡∏° UI ‡πÄ‡∏î‡∏¥‡∏° */
  .manual-item {
    position: relative;
    display: flex;
    gap: 12px;
    align-items: center;
    padding: 14px 16px;
    border-radius: var(--radius);
    border: 1px solid var(--line);
    background: var(--paper);
    color: var(--ink);
    text-decoration: none;
    font-weight: 700;
    box-shadow: var(--shadow);
    transition: transform .15s ease, box-shadow .15s ease;
    overflow: hidden;
  }
  .manual-item::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 6px;
    background-color: var(--brand);
  }

  .manual-item:focus-visible { outline: 2px solid var(--brand); outline-offset: 2px; }
  .manual-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px -6px rgba(0,0,0,.2);
  }
  .manual-item:active { transform: translateY(0); }

  .item-icon {
    width: 40px; height: 40px;
    border-radius: var(--radius);
    display: grid; place-items: center;
    background: #e8ede7;
    color: var(--brand);
    flex: 0 0 40px;
  }
  .item-icon svg { width: 24px; height: 24px; }
  .item-text small { display: block; color: var(--muted); font-weight: 400; font-size: 13px; }
  
  footer {
    margin-top: 30px;
    text-align: center;
  }
  .footer-links {
    color: var(--muted);
    font-size: 14px;
  }

  /* ===== CSS ‡∏Ç‡∏≠‡∏á Chatbot UI (Military Theme) ===== */
  .chat-bubble::before { content: ''; position: absolute; width: 0; height: 0; border-style: solid; }
  .chat-bubble-user::before {
    border-width: 0 12px 12px 12px; border-color: transparent transparent #4a5c43 transparent; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏´‡∏≤‡∏£ */
    top: -10px; right: 12px;
  }
  .chat-bubble-model::before {
    border-width: 0 12px 12px 12px; border-color: transparent transparent #e5e7eb transparent;
    top: -10px; left: 12px;
  }
  .gemini-thinking-bar {
    position: relative; width: 100%; height: 4px; background-color: #e0e0e0;
    border-radius: 2px; overflow: hidden;
  }
  .gemini-thinking-bar::before {
    content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%;
    background: linear-gradient(90deg, #4a5c43, #8f9e8a, #4a5c43);
    background-size: 200% 100%; animation: thinking-gradient 2s linear infinite;
  }
  @keyframes thinking-gradient { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  
  #fab-chat-toggle {
    position: fixed; bottom: 25px; right: 25px;
    width: 60px; height: 60px;
    background-color: var(--brand); /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ó‡∏´‡∏≤‡∏£ */
    color: white;
    border: none; border-radius: 50%;
    font-size: 28px; line-height: 60px; text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    cursor: pointer; z-index: 998;
    transition: transform 0.2s, opacity 0.3s;
  }
  #fab-chat-toggle:hover { transform: scale(1.05); background-color: var(--brand-dark); }
  
  #chatbot-modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    z-index: 1000; transition: opacity 0.3s, transform 0.3s;
    opacity: 1; transform: translateY(0); pointer-events: auto;
  }
  #chatbot-modal.chatbot-hidden {
    opacity: 0; transform: translateY(100%); pointer-events: none;
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="crest" aria-hidden="true">‚òÖ</div>
    <div>
      <h1>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å‡∏ó‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h1>
      <p class="subtitle">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô | ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡πà‡∏≤‡∏ó‡∏´‡∏≤‡∏£ & ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</p>
    </div>
  </div>

  <div class="section">
    <h2>‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h2>
    <div class="grid">
      <a class="manual-item" href="https://sites.google.com/view/kuthahanmai/%E0%B9%81%E0%B8%9C%E0%B8%99%E0%B8%9A%E0%B8%97%E0%B9%80%E0%B8%A3%E0%B8%A2%E0%B8%99" target="_blank" rel="noopener">
        <div class="item-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="m16.24 7.76-2.12 6.36-6.36 2.12 2.12-6.36 6.36-2.12z"></path></svg>
        </div>
        <div class="item-text"><div>‡πÅ‡∏ú‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div><small>‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</small></div>
      </a>
      <a class="manual-item" href="https://sites.google.com/view/kuthahanmai/%E0%B8%9A%E0%B8%84%E0%B8%84%E0%B8%A5%E0%B8%97%E0%B8%B2%E0%B8%AD%E0%B8%B2%E0%B8%A7%E0%B8%98-m16" target="_blank" rel="noopener">
        <div class="item-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5 6 22"></path><path d="M17 5.5c-1.88.7-3.48 2.3-4.5 4"></path><path d="M20 13c-2.02 1.34-4.52 2-7.5 2-3.32 0-6.18-1-8.5-2.5"></path><path d="M22 6.5c-1.5 1-3.12 2.4-5.5 3.5"></path><path d="m15 12-2.5-2.5"></path><path d="M3 14.5 11 9"></path></svg>
        </div>
        <div class="item-text"><div>‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡πà‡∏≤‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò M16</div><small>‡∏ó‡πà‡∏≤‡∏¢‡∏∑‡∏ô ‡∏à‡∏±‡∏ö ‡∏û‡∏≤‡∏î ‡∏ö‡∏£‡∏£‡∏à‡∏∏ ‡∏õ‡∏•‡πà‡∏≠‡∏¢</small></div>
      </a>
      <a class="manual-item" href="https://sites.google.com/view/kuthahanmai/%E0%B8%9A%E0%B8%84%E0%B8%84%E0%B8%A5%E0%B8%97%E0%B8%B2%E0%B8%AD%E0%B8%B2%E0%B8%A7%E0%B8%98-tar" target="_blank" rel="noopener">
        <div class="item-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
        </div>
        <div class="item-text"><div>‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡πà‡∏≤‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò TAR</div><small>‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∏‡πâ‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</small></div>
      </a>
      <a class="manual-item" href="https://sites.google.com/view/kuthahanmai/%E0%B8%9A%E0%B8%84%E0%B8%84%E0%B8%A5%E0%B8%97%E0%B8%B2%E0%B8%A1%E0%B8%AD%E0%B9%80%E0%B8%9B%E0%B8%A5%E0%B8%B2" target="_blank" rel="noopener">
        <div class="item-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 9v4c0 2.76-4 5-6 5s-6-2.24-6-5V9"></path><path d="M12 14v8"></path><circle cx="12" cy="5" r="2"></circle><path d="M6 11V9a6 6 0 0 1 12 0v2"></path></svg>
        </div>
        <div class="item-text"><div>‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤</div><small>‡∏ó‡πà‡∏≤‡∏ï‡∏£‡∏á‚Äì‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‚Äì‡∏´‡∏±‡∏ô‚Äì‡∏Å‡πâ‡∏≤‡∏ß</small></div>
      </a>
      <a class="manual-item" href="https://sites.google.com/view/kuthahanmai/%E0%B8%A7%E0%B8%8A%E0%B8%B2%E0%B8%97%E0%B8%AB%E0%B8%B2%E0%B8%A3%E0%B9%83%E0%B8%AB%E0%B8%A1" target="_blank" rel="noopener">
        <div class="item-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
        </div>
        <div class="item-text"><div>‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div><small>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏Å‡∏é ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö</small></div>
      </a>
      <a class="manual-item" href="https://sites.google.com/view/kuthahanmai/%E0%B9%80%E0%B8%9E%E0%B8%A5%E0%B8%87%E0%B8%97%E0%B8%AB%E0%B8%B2%E0%B8%A3" target="_blank" rel="noopener">
        <div class="item-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
        </div>
        <div class="item-text"><div>‡πÄ‡∏û‡∏•‡∏á‡∏ó‡∏´‡∏≤‡∏£</div><small>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à</small></div>
      </a>
    </div>
  </div>

  <footer>
    <p class="footer-links">
      ¬© 2025 Crow Studio |
      <a href="https://sites.google.com/view/privacy-policy-pdpa-crow-studi/%E0%B8%AB%E0%B8%99%E0%B8%B2%E0%B9%81%E0%B8%A3%E0%B8%81">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a> |
      <a href="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á">‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
    </p>
  </footer>

  <button id="fab-chat-toggle" title="‡∏ñ‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å">Ai</button>

  <div id="chatbot-modal" class="chatbot-hidden">
    <div class="flex flex-col h-screen bg-gray-100">
      <header class="bg-[#4a5c43] text-white p-4 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-2">
            <span class="text-xl">‚≠ê</span>
            <h1 class="text-lg font-bold font-sans text-white m-0">AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å</h1>
        </div>
        <div>
          <button id="new-chat-btn" class="bg-[#f4f1e8] hover:bg-[#dcdfda] text-[#4a5c43] font-bold py-1 px-3 rounded mr-2 text-sm">
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
          </button>
          <button id="chatbot-close-btn" class="bg-gray-700 hover:bg-gray-900 text-white font-bold py-1 px-3 rounded text-sm">
            ‡∏õ‡∏¥‡∏î
          </button>
        </div>
      </header>

      <main id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#f4f1e8]">
        <div class="flex items-start space-x-2">
          <span class="text-2xl">ü§ñ</span>
          <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡πà‡∏≤‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏ó‡πà‡∏≤‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò ‡∏Å‡∏é‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö</p>
          </div>
        </div>
      </main>

      <div id="thinking-indicator" class="p-4 hidden bg-[#f4f1e8]">
        <div class="flex items-center space-x-2">
          <span class="text-2xl">ü§ñ</span>
          <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200">
            <div class="gemini-thinking-bar"></div>
          </div>
        </div>
      </div>

      <footer class="bg-white p-3 shadow-inner border-t border-gray-200 m-0 w-full max-w-full">
        <div class="flex space-x-2">
          <input id="user-input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡πà‡∏≤‡∏ï‡∏£‡∏á, ‡∏õ‡∏•‡∏î‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò)..." class="flex-1 p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#4a5c43] font-sans text-base">
          <button id="send-btn" class="bg-[#4a5c43] hover:bg-[#354230] text-white font-bold py-2 px-4 rounded-xl shadow-sm">
            ‡∏™‡πà‡∏á
          </button>
        </div>
      </footer>
    </div>
  </div>

<script>
/** =========================================
    ‡∏™‡πà‡∏ß‡∏ô Chatbot AI (Backend)
    ========================================= */
const BACKEND_URL = 'https://us-central1-law-ai-14740.cloudfunctions.net/api/chat';

// System Prompt: ‡∏õ‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å‡∏ó‡∏´‡∏≤‡∏£"
const SYSTEM_PROMPT = {
    role: "user",
    parts: [{ text: "System Instruction: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å‡∏ó‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà (AI Assistant Instructor) ‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û‡∏ö‡∏Å, ‡∏ó‡πà‡∏≤‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏°‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤, ‡∏ó‡πà‡∏≤‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò (M16, TAR), ‡∏Å‡∏≤‡∏£‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏ï‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏ï‡πà‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏ß‡πà‡∏≤ '‡∏Ñ‡∏£‡∏±‡∏ö' ‡πÄ‡∏™‡∏°‡∏≠) ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏û‡∏•‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£" }]
};
const SYSTEM_ACK = {
    role: "model",
    parts: [{ text: "‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ú‡∏° ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö" }]
};

let chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];

const chatHistoryEl = document.getElementById('chat-history');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const newChatBtn = document.getElementById('new-chat-btn');
const thinkingIndicator = document.getElementById('thinking-indicator');

function addChatBubble(message, isUser = true) {
    const bubbleType = isUser ? 'user' : 'model';
    const icon = isUser ? 'üë§' : 'ü§ñ';
    // ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏µ Bubble ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ò‡∏µ‡∏° Military Green
    const bgClass = isUser ? 'bg-[#4a5c43] text-white' : 'bg-white text-gray-800 border border-gray-200';
    
    const wrap = document.createElement('div');
    wrap.className = `flex items-start space-x-2 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble chat-bubble-${bubbleType} ${bgClass} p-3 rounded-lg max-w-lg relative shadow-sm`;
    bubble.innerHTML = `<p>${message.replace(/\n/g, '<br>')}</p>`;
    
    wrap.innerHTML = `<span class="text-2xl">${icon}</span>`;
    wrap.appendChild(bubble);
    
    chatHistoryEl.appendChild(wrap);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function addChatError(message) {
    const w = document.createElement('div');
    w.className = 'flex justify-center my-2';
    w.innerHTML = `<span class="bg-red-100 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">${message}</span>`;
    chatHistoryEl.appendChild(w);
    chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

function setThinking(on) {
    thinkingIndicator.classList.toggle('hidden', !on);
    if (on) chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
}

async function handleSend() {
    const message = (userInput.value || '').trim();
    if (!message) return;

    addChatBubble(message, true);
    userInput.value = '';
    setThinking(true);
    sendBtn.disabled = true;

    chatHistory.push({ role: "user", parts: [{ text: message }] });

    try {
        const response = await fetch(BACKEND_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history: chatHistory }) 
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.error || `Server error: ${response.status}`);
        }

        const data = await response.json(); 
        const aiReply = data.reply;

        chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
        setThinking(false);
        addChatBubble(aiReply, false);

    } catch (err) {
        console.error("Fetch Error:", err);
        setThinking(false);
        addChatError(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`);
        chatHistory.pop();
    } finally {
        sendBtn.disabled = false;
    }
}

sendBtn.addEventListener('click', handleSend);
userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') handleSend();
});

// Reset Chat
newChatBtn.addEventListener('click', () => {
    chatHistory = [SYSTEM_PROMPT, SYSTEM_ACK];
    chatHistoryEl.innerHTML = `
        <div class="flex items-start space-x-2">
        <span class="text-2xl">ü§ñ</span>
        <div class="chat-bubble chat-bubble-model bg-white text-gray-800 p-3 rounded-lg max-w-lg relative border border-gray-200 shadow-sm">
            <p>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏£‡∏π‡∏ù‡∏∂‡∏Å ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö</p>
        </div>
        </div>`;
    userInput.value = '';
    setThinking(false);
});

// Modal Control
const fabToggle = document.getElementById('fab-chat-toggle');
const chatModal = document.getElementById('chatbot-modal');
const chatbotCloseBtn = document.getElementById('chatbot-close-btn');

fabToggle.addEventListener('click', () => {
    chatModal.classList.remove('chatbot-hidden');
    fabToggle.style.opacity = '0';
});
chatbotCloseBtn.addEventListener('click', () => {
    chatModal.classList.add('chatbot-hidden');
    fabToggle.style.opacity = '1';
});

</script>
</div>
</body>
</html>
